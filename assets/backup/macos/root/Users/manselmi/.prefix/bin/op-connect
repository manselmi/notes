#!/usr/bin/env -S -- python -B
# vim: set ft=python :

import os
import shutil
import signal
import subprocess
import sys
from pathlib import Path

COMPOSE = os.environ.get("OP_CONNECT_COMPOSE") or str(
    Path.home().joinpath(".config/op-connect/compose.yaml")
)
CURL = shutil.which("curl")
DOCKER = shutil.which("docker")
UNIX_SOCKET_SCHEME = "unix://"
UNIX_SOCKET_URL = (
    os.environ.get("DOCKER_UNIX_SOCKET_URL") or f"{UNIX_SOCKET_SCHEME}/var/run/docker.sock"
)


def main():
    # https://docs.docker.com/reference/api/engine/latest/#tag/System/operation/SystemPing
    subprocess.run(  # noqa:S603
        [
            CURL,
            "-q",
            "-v",
            "--fail",
            "--max-time",
            os.environ.get("CURL_MAX_TIME_SECONDS") or "1",
            "--no-progress-meter",
            "--output",
            os.devnull,
            "--retry",
            os.environ.get("CURL_RETRY") or "5",
            "--retry-all-errors",
            "--unix-socket",
            UNIX_SOCKET_URL.removeprefix(UNIX_SOCKET_SCHEME),
            "--",
            "http/_ping",
        ],
        check=True,
    )

    env = {
        "OP_HTTP_PORT": os.environ.get("OP_HTTP_PORT") or "5080",
        "OP_HTTPS_PORT": os.environ.get("OP_HTTPS_PORT") or "5443",
        "OP_LOG_LEVEL": os.environ.get("OP_LOG_LEVEL") or "info",
        "OP_SESSION": subprocess.run(  # noqa:S603
            [
                "/usr/bin/security",
                "find-generic-password",
                "-s",
                (
                    os.environ.get("OP_SESSION_KEYCHAIN_RECORD_SERVICE")
                    or "com.manselmi.op.connect.server"
                ),
                "-a",
                os.environ.get("OP_SESSION_KEYCHAIN_RECORD_ACCOUNT") or "OP_SESSION",
                "-w",
                "--",
                *list(filter(None, [os.environ.get("OP_SESSION_KEYCHAIN_PATH")])),
            ],
            check=True,
            encoding="ascii",
            stdout=subprocess.PIPE,
        ).stdout,
        "OP_SYNC_TIMEOUT": os.environ.get("OP_SYNC_TIMEOUT") or "10s",
    }

    process = None

    def handler(signum, frame):  # noqa:ARG001
        if process is not None:
            subprocess.Popen(  # noqa:S603
                [DOCKER, "-H", UNIX_SOCKET_URL, "compose", "-f", COMPOSE, "down"],
                env=env,
                start_new_session=True,
                stderr=subprocess.DEVNULL,
                stdout=subprocess.DEVNULL,
            )

    signal.signal(signal.SIGINT, handler)
    signal.signal(signal.SIGTERM, handler)

    process = subprocess.Popen(  # noqa:S603
        [DOCKER, "-H", UNIX_SOCKET_URL, "compose", "-f", COMPOSE, "up"],
        env=env,
        start_new_session=True,
    )
    process.wait()

    sys.exit(process.returncode)


if __name__ == "__main__":
    main()
